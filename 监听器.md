# :santa: 监听器

>在Servlet中可以将监听器分为3类：ServeltRequest事件监听器，ServletContext事件监听器和HTTPSession事件监听器。

### :christmas_tree: ServeltRequest监听器 ###

ServeltRequest事件监听器用于监听请求信息对象，主要用于对象创建和销毁事件，当请求位于Web应用程序范围中时，将会执行。它主要是使用ServletRequestListener接口与ServletRequestAttributeListener接口，其作用分别如下：

**ServletRequestListener接口**

用于request内置对象的创建与销毁事件，当request请求到达第一个servelt程序或者过滤器时，将会触发，销毁也会执行。这个接口主要实现两个方法：

  * `requestInitialized(ServletRequestEvent sre)` : 创建时触发事件
  
  * `requestDestroyed(ServletRequestEvent sre)` ： 销毁时触发事件

如下，我们用于一个显示用户信息发送请求的时间与信息：


新建一个监听类：

```java
public class log implements ServletRequestListener  //继承接口
{
    public void requestInitialized(ServletRequestEvent sre)
    {
        try {
            HttpServletRequest request = (HttpServletRequest)sre.getServletRequest();  //获取request对象
            String userInfo = new Date().toString()+request.getCookies()[0].getName();  //获取第一个Cookies信息
            request.setAttribute("user",userInfo);                  //添加变量
        }
        catch (Exception e){
            e.printStackTrace();
        }

    }
    public  void requestDestroyed(ServletRequestEvent sre){

    }
}
```

然后在jsp页面得到这个信息：

```jsp
<body>
        <%=request.getAttribute("user")%>
</body>
```

最后在web.xml设置：

```xml
    <listener>
        <listener-class>Deal.log</listener-class>
    </listener>
```

点击运行，每刷新一次页面就会变更信息。这是由于jsp页面本身就是一个servelt，所以这个页面每执行一次，就会触发事件，当让这样记录登录信息一般不用于输出，而应该是写入日志里面，即用以用一个文件来存放日志,将信息都写入文件中

```java
public class log implements ServletRequestListener
{
    public void requestInitialized(ServletRequestEvent sre)
    {
        try {

            HttpServletRequest request = (HttpServletRequest)sre.getServletRequest();
            //获取文件的物理地址
            String url = getClass().getResource("/").getPath()+"..\\..\\text\\log.txt";

            File file = new File(url);
            FileWriter out = new FileWriter(file);

            //写入文件后关闭这个写入流
            out.write("Lumnca最新登录时间"+new Date());
            out.close();
        }
        catch (Exception e){
            e.printStackTrace();
        }

    }
    public  void requestDestroyed(ServletRequestEvent sre){

    }
}
```
**ServletRequestAttributeListener接口**

该接口只要是监控request属性的变化，包括添加属性，删除，更新。这个接口定义了三个方法来对应这三种操作：

`attributeAdded(ServletRequestAttributeEvent srae)` : 添加执行，即使用了 request.setAttribute()方法触发;

`attributeRemoved(ServletRequestAttributeEvent srae)` : 删除执行，当使用 request.removeAttribute()方法触发。
 
`attributeReplaced(ServletRequestAttributeEvent srae)` : 更新执行，当时用了request.setAttribute()修改或者 request.removeAttribute()移除触发

下面是一个用户登录时监听器的模拟：

```java
public class change implements ServletRequestAttributeListener
{
    public  void attributeAdded(ServletRequestAttributeEvent srae)
    {
        HttpServletRequest request = (HttpServletRequest)srae.getServletRequest();     //获取request对象
        request.setAttribute("info","添加了1条记录\n" +"用户:"+srae.getName()+"\n"+"密码:"+srae.getValue());  //返回给jsp页面显示
    }
    public  void attributeRemoved(ServletRequestAttributeEvent srae){
         
    }
    public void attributeReplaced(ServletRequestAttributeEvent srae){

    }
}
```

上面只对添加进行了监听，其他操作可自行设计，使用getName()可以获得更新属性的键，getValue()可以获得键对应的值

jsp页面处理：

```jsp
<body>
        <form>
            <label>用户</label>
            <input type="text" placeholder="用户" name="user"><br>
            <label>密码</label>
            <input type="password" placeholder="密码" name="pw"><br>
            <input type="submit" value="提交">
        </form>
        <%

            String user =  request.getParameter("user");
            String pw =  request.getParameter("pw");
            if(user!=null&&pw!=null){
                request.setAttribute(user,pw);            //添加
                out.println(request.getAttribute("info"));  //显示监听器内容
            } 
        %>
</body>
```


最后在web.xml中添加监听器：

```xml
    <listener>
        <listener-class>Deal.change</listener-class>  <!--监听器所在包-->
    </listener>
```

点击运行，输入用户与密码即可看到效果。








